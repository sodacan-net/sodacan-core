<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Control Panel</title>
	<link href="css/bootstrap.min.css" rel="stylesheet" >    <!-- JavaScript Bundle with Popper -->
	<script src="js/bootstrap.bundle.min.js"></script>
	<script src="js/jquery-Latest.min.js" ></script>

	<link href="sodacan.css" rel="stylesheet" >
  </head>
  <body>
	<div class="container">
		<nav class="navbar navbar-dark bg-secondary">
			<div class="container">
				<a class="navbar-brand" href="#"> Sodacan - 101 Eden </a>
			</div>
		</nav>
		<div class="container">
			<div class=" widget switch event" data-event="button1" data-follow="lamp1">
				<div class="widget-content">
					<div class="follow-name" ></div>
					<h1 class='bi bi-lightbulb'></h1>
					<h4 class="value"></h4>
					<div class="event-name" ></div>
					</div>
			</div>
			<div class=" widget switch" data-follow="lamp1">
				<div class="widget-content">
					<div class="follow-name" ></div>
					<h1 class='bi bi-lightbulb'></h1>
					<h4 class="value"></h4>
					<div class="event-name" ></div>
				</div>
			</div>
			<div class=" widget event" data-event="button1">
				<div class="widget-content">
					<div class="follow-name" ></div>
					<h1 class='bi bi-box-arrow-right'></h1>
					<div class="event-name" ></div>
				</div>
			</div>
			<div class="widget"	data-follow="wellpump">
				<div class="value">Waiting...</div>
				<div class="progress-bar" role="progressbar" aria-valuenow="40"
					aria-valuemin="0" aria-valuemax="100" style="height: 40%;">
					<flower />
					<span class="sr-only">40% Complete</span>
				</div>
			</div>
			<div class="widget progress" data-event="button1">
				<div class="progress-bar" role="progressbar" aria-valuenow="20"
					aria-valuemin="0" aria-valuemax="100" style="height: 20%;">
					<span id="lamp2" class="sr-only">20% Complete</span>
				</div>
			</div>
			<div class="widget wide tall">
				<h5>Status</h5>
				<p id="status" class="card-text"></p>
			</div>
			<div class="widget"	data-follow="unused">
			</div>
		</div>
	</div>

	<script>
$('flower').replaceWith("<i class='bi bi-flower2'></i>");

// A widget can generate an event if secified
$('[data-event]').on('click', function() {
  $.get("/api/event/" + $( this ).data("event"));
//  console.log("Click");
});

$('[data-event]').each(function () {
	$(this).find(".event-name").text($(this).data("event"));
});
$('[data-follow]').each(function () {
	$(this).find(".follow-name").text($(this).data("follow"));
});

var source = new EventSource("/api/subscribe");
source.onmessage = function(event) {
	const p = JSON.parse(event.data);
	if (p.type=="state") {
		$('[data-follow="' + p.state.name + '"]').each(function(index) {
			$(this).removeClass( $(this).find(".value").text());
			$(this).find(".value").text(p.state.value);
			$(this).addClass( p.state.value);
		});
	}
};
source.onopen = function(event) {
	document.getElementById("status").innerHTML = "Connection to server established";
	  $.get("/api/states", function(data) {
		  const states = JSON.parse(data);
		  for (let s in states) {
				var selector = '[data-follow="' + states[s].name + '"] .value';
				$(selector).text(states[s].value);
				$('[data-follow="' + states[s].name + '"]').addClass( states[s].value);
		  }

	});
	
};
source.onerror = function(event) {
	$("#status").text("lost connection to server");
};

</script>
</body>